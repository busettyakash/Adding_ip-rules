name: Configure Argo CD on AKS with HTTPS

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  argo-cd-prod:
    runs-on: ubuntu-latest
    env:
      KUBECONFIG: ${{ github.workspace }}/kubeconfig

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- Azure OIDC Login ---
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # --- Get AKS credentials ---
      - name: Get AKS credentials
        run: |
          az aks get-credentials --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
                                 --name ${{ secrets.AKS_CLUSTER_NAME }} \
                                 --file $KUBECONFIG --overwrite-existing
          kubectl config view

      # --- Test cluster connectivity ---
      - name: Test cluster connectivity
        run: kubectl get nodes

      # --- Ensure Argo CD namespace exists ---
      - name: Ensure Argo CD namespace
        run: |
          NAMESPACE="gvk-argocd"
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      # --- Install Argo CD if not already installed ---
      - name: Install Argo CD
        run: |
          NAMESPACE="gvk-argocd"
          if ! kubectl get deployment -n $NAMESPACE argocd-server >/dev/null 2>&1; then
            kubectl apply -n $NAMESPACE -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          else
            echo "Argo CD already installed, skipping installation."
          fi

      # --- Install Cert-Manager ---
      - name: Install Cert-Manager
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/latest/download/cert-manager.yaml
          kubectl wait --for=condition=Available deployment -n cert-manager cert-manager --timeout=180s
          kubectl wait --for=condition=Available deployment -n cert-manager cert-manager-webhook --timeout=180s
          kubectl wait --for=condition=Available deployment -n cert-manager cert-manager-cainjector --timeout=180s

      # --- Create or update ClusterIssuer ---
      - name: Create ClusterIssuer for Let’s Encrypt
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt
          spec:
            acme:
              email: ${{ secrets.LETSENCRYPT_EMAIL }}
              server: https://acme-v02.api.letsencrypt.org/directory
              privateKeySecretRef:
                name: letsencrypt-private-key
              solvers:
                - http01:
                    ingress:
                      class: nginx
          EOF

      # --- Apply Ingress for Argo CD ---
      - name: Apply Ingress for Argo CD
        run: |
          NAMESPACE="gvk-argocd"
          DOMAIN_NAME="${{ secrets.PUBLIC_DOMAIN }}" # e.g., gvk-platform.com
          cat <<EOF | kubectl apply -f -
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: argocd-server-ingress
            namespace: $NAMESPACE
            annotations:
              kubernetes.io/ingress.class: nginx
              cert-manager.io/cluster-issuer: letsencrypt
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
          spec:
            rules:
              - host: $DOMAIN_NAME
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: argocd-server
                          port:
                            number: 443
            tls:
              - hosts:
                  - $DOMAIN_NAME
                secretName: argocd-tls
          EOF

      # --- Wait for Argo CD server pod ---
      - name: Wait for Argo CD server pod
        run: |
          NAMESPACE="gvk-argocd"
          kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=argocd-server -n $NAMESPACE --timeout=180s

      # --- Wait for TLS certificate to be issued ---
      - name: Wait for TLS certificate
        run: |
          NAMESPACE="gvk-argocd"
          DOMAIN_NAME="${{ secrets.PUBLIC_DOMAIN }}"
          kubectl wait --for=condition=Ready certificate argocd-tls -n $NAMESPACE --timeout=300s
          echo "✅ TLS certificate issued for $DOMAIN_NAME"

      # --- Set Argo CD admin password ---
      - name: Set Argo CD admin password
        run: |
          NAMESPACE="gvk-argocd"
          CUSTOM_PASSWORD="${{ secrets.ARGOCD_ADMIN_PASSWORD }}"
          sudo apt-get update && sudo apt-get install -y apache2-utils
          HASH=$(htpasswd -bnBC 10 "" "$CUSTOM_PASSWORD" | tr -d ':\n')
          kubectl -n $NAMESPACE patch secret argocd-secret \
            -p "{\"stringData\": {\"admin.password\": \"$HASH\", \"admin.passwordMtime\": \"$(date +%FT%T%Z)\"}}"
          echo "✅ Admin password updated"

      # --- Output login info ---
      - name: Output Argo CD URL
        run: |
          echo "🌐 Argo CD URL: https://${{ secrets.PUBLIC_DOMAIN }}"
          echo "🔑 Admin username: admin"
          echo "🔑 Admin password: ${{ secrets.ARGOCD_ADMIN_PASSWORD }}"
