name: Configure Argo CD on AKS with HTTPS

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  argo-cd-prod:
    runs-on: ubuntu-latest
    env:
      KUBECONFIG: ${{ github.workspace }}/kubeconfig

    steps:
      # --- Checkout repository ---
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- Azure OIDC Login ---
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # --- Get AKS credentials ---
      - name: Get AKS credentials
        run: |
          az aks get-credentials --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
                                 --name ${{ secrets.AKS_CLUSTER_NAME }} \
                                 --file $KUBECONFIG --overwrite-existing
          kubectl config view

      # --- Test cluster connectivity ---
      - name: Test cluster connectivity
        run: kubectl get nodes

      # --- Ensure Argo CD namespace exists ---
      - name: Ensure Argo CD namespace
        run: |
          NAMESPACE="gvk-argocd"
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      # --- Install NGINX Ingress Controller ---
      - name: Install NGINX Ingress Controller
        run: |
          if ! kubectl get ns ingress-nginx >/dev/null 2>&1; then
            echo "üì¶ Installing NGINX Ingress Controller..."
            kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
            kubectl wait --for=condition=Available deployment/ingress-nginx-controller -n ingress-nginx --timeout=300s
          else
            echo "‚úÖ NGINX Ingress Controller already installed."
          fi

      # --- Install Argo CD if not installed ---
      - name: Install Argo CD
        run: |
          NAMESPACE="gvk-argocd"
          if ! kubectl get deployment -n $NAMESPACE argocd-server >/dev/null 2>&1; then
            echo "üì¶ Installing Argo CD..."
            kubectl apply -n $NAMESPACE -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          else
            echo "‚úÖ Argo CD already installed, skipping installation."
          fi

      # --- Install Cert-Manager ---
      - name: Install Cert-Manager
        run: |
          kubectl create namespace cert-manager --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/latest/download/cert-manager.yaml
          kubectl wait --for=condition=Available deployment -n cert-manager cert-manager --timeout=180s
          kubectl wait --for=condition=Available deployment -n cert-manager cert-manager-webhook --timeout=180s
          kubectl wait --for=condition=Available deployment -n cert-manager cert-manager-cainjector --timeout=180s

      # --- Create ClusterIssuer for Let‚Äôs Encrypt ---
      - name: Create ClusterIssuer
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt
          spec:
            acme:
              email: ${{ secrets.LETSENCRYPT_EMAIL }}
              server: https://acme-v02.api.letsencrypt.org/directory
              privateKeySecretRef:
                name: letsencrypt-private-key
              solvers:
                - http01:
                    ingress:
                      class: nginx
          EOF

      # --- Apply Ingress for Argo CD ---
      - name: Apply Ingress for Argo CD
        run: |
          NAMESPACE="gvk-argocd"
          DOMAIN_NAME="${{ secrets.PUBLIC_DOMAIN }}"
          cat <<EOF | kubectl apply -f -
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: argocd-server-ingress
            namespace: $NAMESPACE
            annotations:
              kubernetes.io/ingress.class: nginx
              cert-manager.io/cluster-issuer: letsencrypt
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
          spec:
            rules:
              - host: $DOMAIN_NAME
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: argocd-server
                          port:
                            number: 443
            tls:
              - hosts:
                  - $DOMAIN_NAME
                secretName: argocd-tls
          EOF

      # --- Wait for Argo CD server pod ---
      - name: Wait for Argo CD server pod
        run: |
          NAMESPACE="gvk-argocd"
          kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=argocd-server -n $NAMESPACE --timeout=300s

      # --- Wait for Certificate resource and readiness ---
      - name: Wait for TLS certificate
        run: |
          NAMESPACE="gvk-argocd"
          for i in {1..20}; do
            if kubectl get certificate argocd-tls -n $NAMESPACE >/dev/null 2>&1; then
              echo "‚úÖ Certificate resource found."
              break
            fi
            echo "‚è≥ Waiting for Certificate resource..."
            sleep 30
          done
          kubectl wait --for=condition=Ready certificate/argocd-tls -n $NAMESPACE --timeout=600s
          echo "‚úÖ TLS certificate issued successfully."

      # --- Set Argo CD admin password ---
      - name: Set Argo CD admin password
        run: |
          NAMESPACE="gvk-argocd"
          CUSTOM_PASSWORD="${{ secrets.ARGOCD_ADMIN_PASSWORD }}"
          sudo apt-get update && sudo apt-get install -y apache2-utils
          HASH=$(htpasswd -bnBC 10 "" "$CUSTOM_PASSWORD" | tr -d ':\n')
          kubectl -n $NAMESPACE patch secret argocd-secret \
            -p "{\"stringData\": {\"admin.password\": \"$HASH\", \"admin.passwordMtime\": \"$(date +%FT%T%Z)\"}}"
          echo "‚úÖ Admin password updated successfully."

      # --- Output LoadBalancer IP for DNS setup ---
      - name: Output LoadBalancer IP
        run: |
          echo "üåê Use this IP to update your DNS A record:"
          kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}'

      # --- Output Argo CD URL ---
      - name: Output Argo CD URL
        run: |
          echo "üåê Argo CD URL: https://${{ secrets.PUBLIC_DOMAIN }}"
          echo "üîë Admin username: admin"
          echo "üîë Admin password: ${{ secrets.ARGOCD_ADMIN_PASSWORD }}"
